<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="output.css">
    <title>CRUD Operations</title>
</head>
<body>

    <div class="h-screen flex">
        <div class="h-screen w-1/3 flex flex-col items-center justify-center">
            <article class="prose">
                <h1>CRUD Operations</h1>
            </article>
        
            <div class="flex flex-col justify-center p-4">
                <button class="btn btn-primary m-3" id="createProduct">Create Product</button>
                <button class="btn btn-primary m-3" id="getProducts">Get Products</button>
                <button class="btn btn-disabled m-3" id="updateProduct">Update Product</button>
                <button class="btn btn-disabled m-3" id="deleteProduct">Delete Product</button>
            </div>
        </div>

        <div class="h-screen w-2/3" id="functionPanel"></div>

    </div>

    <script>
        let currentIndex = 0;
        let products = [];

        function deleteProductClickHandler() {
            const confirmDelete = confirm('Are you sure you want to delete this product?');
            if (confirmDelete) {
                fetch(`/deleteProduct/${products[currentIndex]._id}`, {
                    method: 'DELETE'
                })
                .then(response => response.text())
                .then(result => {
                    alert(result);
                    // Refresh the products after deletion
                    document.getElementById('getProducts').click();
                })
                .catch(error => console.error('Error deleting product:', error));
            }
        }

        document.getElementById('deleteProduct').addEventListener('click', deleteProductClickHandler);

        function getProductsClickHandler() {
            fetch('/getProducts')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    products = data; // Assign fetched products to the global variable
                    displayProduct(products, currentIndex); // Display products

                    const deleteButton = document.getElementById('deleteProduct');
                    deleteButton.classList.replace('btn-disabled', 'btn-error');
                    deleteButton.removeEventListener('click', deleteProductClickHandler);
                    deleteButton.addEventListener('click', deleteProductClickHandler);

                    const updateButton = document.getElementById('updateProduct');
                    updateButton.classList.replace('btn-disabled', 'btn-accent');
                })
                .catch(error => {
                    console.error('Error fetching products:', error);
                });
        }

        document.getElementById('getProducts').addEventListener('click', getProductsClickHandler);

        function displayProduct(products, currentIndex) {

            const product = products[currentIndex];
            document.getElementById('functionPanel').innerHTML = `
            <div class="p-4 flex justify-center">
                <div class="flex justify-center" id="navigationButtons">
                    <button class="btn btn-secondary btn-circle btn-outline ${currentIndex === 0 ? 'btn-disabled' : ''} mx-5" id="firstButton">|<<</button>
                    <button class="btn btn-accent btn-circle btn-outline ${currentIndex === 0 ? 'btn-disabled' : ''} mx-5" id="prevButton" ><</button>
                    <button class="btn btn-accent btn-circle btn-outline ${currentIndex === products.length - 1 ? 'btn-disabled' : ''} mx-5" id="nextButton" >></button>
                    <button class="btn btn-secondary btn-circle btn-outline ${currentIndex === products.length - 1 ? 'btn-disabled' : ''} mx-5" id="lastButton" >>>|</button>
                </div>
            </div>

            <div class="flex justify-center">
                <div class="flex justify-center" id="productDisplay">
                    <div class="card shadow-2xl glass w-80 h-100">
                        <figure class="w-fit">
                            <img src="${product.image}" alt="${product.description}" class="w-auto h-auto object-contain">
                        </figure>
                        <div class="card-body">
                            <h2 class="card-title">${product.name}</h2>
                            <p>Price: ${product.price === 0 ? 'Free' : `€${product.price}`}</p>
                            <p>Shipping: ${product.shipping === 0 ? 'Free' : `€${product.shipping}`}</p>
                            <p>Total Price: ${product.price + product.shipping === 0 ? 'Free' : `€${product.price + product.shipping}`}</p>
                        </div>
                    </div>
                </div>
            </div>
            `;

            document.getElementById('firstButton').removeEventListener('click', firstButtonClickHandler);
            document.getElementById('prevButton').removeEventListener('click', prevButtonClickHandler);
            document.getElementById('nextButton').removeEventListener('click', nextButtonClickHandler);
            document.getElementById('lastButton').removeEventListener('click', lastButtonClickHandler);
            

            // Define event listener functions
            function firstButtonClickHandler() {
                if (currentIndex > 0) {
                    displayProduct(products, 0);
                }
            }

            function prevButtonClickHandler() {
                if (currentIndex > 0) {
                    displayProduct(products, currentIndex - 1);
                }
            }

            function nextButtonClickHandler() {
                if (currentIndex < products.length - 1) {
                    displayProduct(products, currentIndex + 1);
                }
            }

            function lastButtonClickHandler() {
                if (currentIndex < products.length - 1) {
                    displayProduct(products, products.length - 1);
                }
            }

            // Add event listeners using the defined functions
            document.getElementById('firstButton').addEventListener('click', firstButtonClickHandler);
            document.getElementById('prevButton').addEventListener('click', prevButtonClickHandler);
            document.getElementById('nextButton').addEventListener('click', nextButtonClickHandler);
            document.getElementById('lastButton').addEventListener('click', lastButtonClickHandler);
        }
        
        document.getElementById('createProduct').addEventListener('click', displayCreateProductForm);

        function displayCreateProductForm() {
            document.getElementById('functionPanel').innerHTML = `
            <div class="card p-4 flex justify-center">
                <form class="card-body" id="createProductForm">
                    <label for="productName">Product Name:</label>
                    <input type="text" id="productName" name="productName"><br>

                    <label for="productDescription">Description:</label>
                    <textarea id="productDescription" name="productDescription" required></textarea><br>

                    <label for="productPrice">Price:</label>
                    <input type="number" id="productPrice" name="productPrice"><br>

                    <label for="productShipping">Shipping:</label>
                    <input type="number" id="productShipping" name="productShipping"><br>

                    <label for="productImage">Image Link:</label>
                    <input type="url" id="productImage" name="productImage" required>

                    <button type="submit" class="btn btn-primary">Submit</button>
                </form>
            </div>
            `;

            const deleteButton = document.getElementById('deleteProduct');
            deleteButton.classList.replace('btn-primary', 'btn-disabled')

            const updateButton = document.getElementById('updateProduct');
            updateButton.classList.replace('btn-primary', 'btn-disabled')

            document.getElementById('createProductForm').addEventListener('submit', async (event) => {
                event.preventDefault();
                const productName = document.getElementById('productName').value;
                const productDescription = document.getElementById('productDescription').value;
                const productPrice = document.getElementById('productPrice').value;
                const productShipping = document.getElementById('productShipping').value;
                const productImage = document.getElementById('productImage').value;

                const response = await fetch(`/createProduct`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: productName,
                        description: productDescription,
                        price: parseFloat(productPrice),
                        shipping: parseFloat(productShipping),
                        image: productImage
                    })
                });
                const result = await response.json();
                alert(`New product created with ID: ${result.id}`);
            });
        }
    </script>
</body>
<footer class="m-11"></footer>
</html>
